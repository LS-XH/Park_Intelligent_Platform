<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简易WebSocket测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .container {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 5px;
        }
        .connection {
            margin-bottom: 20px;
        }
        #messageLog {
            height: 300px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        #messageInput {
            width: 100%;
            height: 80px;
            margin-bottom: 10px;
            padding: 5px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #666;
        }
        .sent {
            border-left-color: #4CAF50;
            background-color: #e8f5e9;
        }
        .received {
            border-left-color: #2196F3;
            background-color: #e3f2fd;
        }
        .system {
            border-left-color: #ff9800;
            background-color: #fff3e0;
        }
        .error {
            border-left-color: #f44336;
            background-color: #ffebee;
        }
        .time {
            color: #666;
            font-size: 0.8em;
        }
        .control-buttons {
            margin-bottom: 20px;
        }
        #simulateBtn {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #simulateBtn.stop {
            background-color: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket测试工具</h1>

        <div class="connection">
            <input type="text" id="serverUrl" value="ws://localhost:5566" style="width: 300px;">
            <button id="connectBtn">连接</button>
        </div>

        <div class="control-buttons">
            <button id="simulateBtn" disabled>开始模拟</button>
        </div>

        <div id="messageLog"></div>

        <div>
            <textarea id="messageInput" placeholder="输入要发送的消息..."></textarea>
            <br>
            <button id="sendBtn" disabled>发送消息</button>
            <button id="clearBtn">清空日志</button>
        </div>
    </div>

    <script>
        // 获取DOM元素
        const serverUrlInput = document.getElementById('serverUrl');
        const connectBtn = document.getElementById('connectBtn');
        const messageLog = document.getElementById('messageLog');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const clearBtn = document.getElementById('clearBtn');
        const simulateBtn = document.getElementById('simulateBtn');

        // WebSocket连接对象
        let ws = null;
        let isConnected = false;
        let isSimulating = false;
        let messageHandler = null;

        // 格式化时间
        function formatTime() {
            const now = new Date();
            return now.toLocaleTimeString();
        }

        // 添加日志
        function addLog(message, type = 'system') {
            const time = formatTime();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `<span class="time">[${time}]</span><br>${message}`;
            messageLog.appendChild(logEntry);
            messageLog.scrollTop = messageLog.scrollHeight;
        }

        // 连接/断开连接
        connectBtn.addEventListener('click', () => {
            if (isConnected) {
                // 断开连接时停止模拟
                if (isSimulating) {
                    simulateBtn.click();
                }

                // 断开连接
                ws.close();
                isConnected = false;
                connectBtn.textContent = '连接';
                sendBtn.disabled = true;
                simulateBtn.disabled = true;
                addLog('已断开连接', 'system');
            } else {
                // 建立连接
                const url = serverUrlInput.value;
                try {
                    ws = new WebSocket(url);

                    ws.onopen = () => {
                        isConnected = true;
                        connectBtn.textContent = '断开';
                        sendBtn.disabled = false;
                        simulateBtn.disabled = false;
                        addLog(`已连接到: ${url}`, 'system');
                    };

                    ws.onmessage = (event) => {
                        // 只有在模拟状态下才处理接收的消息
                        if (isSimulating) {
                            addLog(`收到模拟数据: ${event.data}`, 'received');
                        } else {
                            // 非模拟状态下也显示消息，但标记为普通消息
                            addLog(`收到: ${event.data}`, 'received');
                        }
                    };

                    ws.onerror = (error) => {
                        addLog(`错误: ${error}`, 'error');
                    };

                    ws.onclose = () => {
                        isConnected = false;
                        isSimulating = false;
                        connectBtn.textContent = '连接';
                        sendBtn.disabled = true;
                        simulateBtn.disabled = true;
                        simulateBtn.textContent = '开始模拟';
                        simulateBtn.classList.remove('stop');
                        addLog('连接已关闭', 'system');
                    };
                } catch (e) {
                    addLog(`连接失败: ${e}`, 'error');
                }
            }
        });

        // 发送消息
        sendBtn.addEventListener('click', () => {
            if (!isConnected) return;

            const message = messageInput.value.trim();
            if (message) {
                // 创建JSON格式的数据对象
                const jsonData = {
                    type: "message",  // 可以添加消息类型标识
                    content: message, // 消息内容
                    timestamp: new Date().toISOString() // 可选：添加时间戳
                };

                // 将JSON对象序列化为字符串后发送
                ws.send(JSON.stringify(jsonData));

                addLog(`发送: ${JSON.stringify(jsonData)}`, 'sent');
                messageInput.value = '';
            }
        });


        // 清空日志
        clearBtn.addEventListener('click', () => {
            messageLog.innerHTML = '';
        });

        // 模拟控制 - 开始/停止接收服务器数据
        simulateBtn.addEventListener('click', () => {
            if (!isConnected) return;

            if (!isSimulating) {
                // 开始模拟
                isSimulating = true;
                simulateBtn.textContent = '停止模拟';
                simulateBtn.classList.add('stop');
                addLog('开始接收模拟数据', 'system');

                // 向服务器发送开始模拟的指令（统一JSON格式）
                const jsonData = {
                    type: "control",  // 控制类型指令
                    content: {
                        action: 'start_simulation'  // 具体操作
                    },
                    timestamp: new Date().toISOString()
                };
                ws.send(JSON.stringify(jsonData));
            } else {
                // 停止模拟
                isSimulating = false;
                simulateBtn.textContent = '开始模拟';
                simulateBtn.classList.remove('stop');
                addLog('停止接收模拟数据', 'system');

                // 向服务器发送停止模拟的指令（统一JSON格式）
                const jsonData = {
                    type: "control",  // 控制类型指令
                    content: {
                        action: 'stop_simulation'  // 具体操作
                    },
                    timestamp: new Date().toISOString()
                };
                ws.send(JSON.stringify(jsonData));
            }
        });


        // 按Enter发送消息
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendBtn.click();
            }
        });
    </script>
</body>
</html>